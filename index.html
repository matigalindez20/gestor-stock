<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iPhone Twins - Panel de Control</title>
    <style>
        :root { --brand-yellow: #fdd100; --brand-yellow-hover: #e4bb00; --background-dark: #0d0d0d; --container-dark: #1a1a1a; --text-light: #ffffff; --text-muted: #86868b; --border-dark: #2a2a2a; --success-bg: #1d6a3c; --error-bg: #b12a29; --info-bg: #0c5460; --loading-bg: #856404; --border-radius: 12px; --box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4); }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { font-size: 16px; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: var(--background-dark); color: var(--text-light); display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 100vh; padding: 1.5rem; }
        .logo-container { margin-bottom: 2rem; }
        .logo-animado { max-width: 150px; animation: pulsar 3s ease-in-out infinite; }
        @keyframes pulsar { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        .container { width: 100%; max-width: 90vw; background-color: var(--container-dark); padding: 2.5rem; border-radius: var(--border-radius); box-shadow: var(--box-shadow); border: 1px solid var(--border-dark); position: relative; }
        .container-sm { max-width: 550px; }
        h1, h2 { text-align: center; margin-bottom: 2rem; }
        .hidden { display: none !important; }
        #logout-button { position: absolute; top: 1.5rem; right: 1.5rem; width: auto; padding: 0.5rem 1rem; font-size: 0.9rem; background-color: var(--error-bg); color: white; border-radius: 8px; cursor: pointer; border: none; }
        .nav-tabs { display: flex; border-bottom: 1px solid var(--border-dark); margin-bottom: 2rem; }
        .nav-tab { padding: 1rem 1.5rem; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.2s; color: var(--text-muted); font-weight: 600; }
        .nav-tab.active { color: var(--brand-yellow); border-bottom-color: var(--brand-yellow); }
        .form-group { margin-bottom: 1.25rem; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-muted); font-size: 0.9rem; }
        input, select { width: 100%; padding: 0.8rem 1rem; border: 1px solid var(--border-dark); border-radius: 8px; font-size: 1rem; background-color: #2c2c2e; color: var(--text-light); }
        select { appearance: none; -webkit-appearance: none; background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23fdd100%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.4-5.4-13z%22/%3E%3C/svg%3E'); background-repeat: no-repeat; background-position: right 1rem center; background-size: .65em auto; }
        button { width: 100%; padding: 1rem; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: bold; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 0.75rem; transition: background-color 0.3s, transform 0.1s; }
        button:disabled { background-color: #555 !important; color: #888; cursor: wait; }
        button.spinner-btn.loading .btn-text { display: none; }
        button.spinner-btn.loading .spinner { display: flex; }
        .spinner { display: none; width: 20px; height: 20px; border: 3px solid rgba(255, 255, 255, 0.3); border-top-color: #fff; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        #feedback-message, #login-feedback { text-align: center; padding: 1rem; margin-bottom: 1.5rem; border-radius: 8px; font-weight: 500; animation: fadeIn 0.5s; color: var(--text-light); }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .success { background-color: var(--success-bg); }
        .error { background-color: var(--error-bg); }
        .dashboard-controls { display: flex; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap; }
        .control-btn { padding: 0.75rem 1.5rem; font-size: 1rem; width: auto; background-color: #333; color: var(--text-light); }
        .control-btn.active { background-color: var(--brand-yellow); color: #000; }
        .filters-container { background-color: #252525; padding: 1.5rem; border-radius: var(--border-radius); margin-bottom: 2rem; display: flex; gap: 1.5rem; flex-wrap: wrap; align-items: flex-end; }
        .filter-group { flex: 1; min-width: 150px; }
        .filters-container button { width: auto; padding: 0.8rem 1.5rem; font-size: 0.9rem; background-color: var(--brand-yellow); color: #000; }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border-dark); white-space: nowrap; }
        th { background-color: #2c2c2e; font-weight: 600; color: var(--brand-yellow); }
        tr:hover { background-color: #252525; }
        .dashboard-loader { text-align: center; padding: 2rem; color: var(--text-muted); }
        #scanner-container { width: 100%; border-radius: 8px; overflow: hidden; border: 1px solid var(--border-dark); margin-bottom: 1.5rem; }
    </style>
</head>
<body>
    <div class="logo-container"><img src="./Diseño sin título (26).png" alt="Logo iPhone Twins" class="logo-animado"></div>
    <div id="login-container" class="container container-sm"></div>
    <div id="app-container" class="container hidden">
        <button id="logout-button">Cerrar Sesión</button>
        <div class="nav-tabs">
            <div id="tab-dashboard" class="nav-tab active">Dashboard</div>
            <div id="tab-management" class="nav-tab">Gestión de IMEI</div>
        </div>
        <div id="dashboard-view">
            <div class="dashboard-controls">
                <button id="btn-show-stock" class="control-btn active">Ver Stock</button>
                <button id="btn-show-sales" class="control-btn">Ver Ventas</button>
            </div>
            <div id="stock-section">
                <h2>Stock Actual</h2>
                <div class="filters-container">
                    <div class="filter-group"><label for="filter-stock-model">Modelo</label><select id="filter-stock-model"><option value="">Todos</option></select></div>
                    <div class="filter-group"><label for="filter-stock-color">Color</label><select id="filter-stock-color"><option value="">Todos</option></select></div>
                    <div class="filter-group"><label for="filter-stock-gb">Almacenamiento</label><select id="filter-stock-gb"><option value="">Todos</option></select></div>
                    <div class="filter-group"><label for="filter-stock-bat-min">Batería Mín %</label><input type="number" id="filter-stock-bat-min" placeholder="Ej: 80"></div>
                    <div class="filter-group"><label for="filter-stock-bat-max">Batería Máx %</label><input type="number" id="filter-stock-bat-max" placeholder="Ej: 100"></div>
                    <div class="filter-group"><button id="btn-apply-stock-filters">Filtrar Stock</button></div>
                </div>
                <div id="stock-table-container" class="table-container"><p class="dashboard-loader">Cargando stock...</p></div>
            </div>
            <div id="sales-section" class="hidden">
                 <h2>Historial de Ventas</h2>
                <div class="filters-container">
                    <div class="filter-group"><label for="filter-sales-vendedor">Vendedor</label><select id="filter-sales-vendedor"><option value="">Todos</option></select></div>
                    <div class="filter-group"><label for="filter-sales-start-date">Fecha Desde</label><input type="date" id="filter-sales-start-date"></div>
                    <div class="filter-group"><label for="filter-sales-end-date">Fecha Hasta</label><input type="date" id="filter-sales-end-date"></div>
                    <div class="filter-group"><button id="btn-apply-sales-filters">Filtrar Ventas</button></div>
                </div>
                <div id="sales-table-container" class="table-container"><p class="dashboard-loader">Cargando ventas...</p></div>
            </div>
        </div>
        <div id="management-view" class="container-sm hidden" style="margin: auto;">
             <button id="btn-scan">Escanear IMEI</button>
            <div id="scanner-container" class="hidden"></div>
            <div id="feedback-message" class="hidden"></div>
            <form id="product-form" class="hidden">
                 <div class="form-group"><label for="imei-form">IMEI Escaneado</label><input type="text" id="imei-form" name="imei" readonly required></div>
                 <div class="form-group"><label for="modelo-form">Modelo</label><select id="modelo-form" name="modelo" required></select></div>
                 <div class="form-group"><label for="bateria">Condición de Batería (%)</label><input type="number" id="bateria" name="bateria" placeholder="Ej: 89" min="1" max="100" required></div>
                 <div class="form-group"><label for="color-form">Color</label><select id="color-form" name="color" required></select></div>
                 <div class="form-group"><label for="almacenamiento-form">Almacenamiento</label><select id="almacenamiento-form" name="almacenamiento" required></select></div>
                 <div class="form-group"><label for="detalles-form">Detalles Estéticos</label><select id="detalles-form" name="detalles" required></select></div>
                 <button type="submit" id="btn-submit-form" class="spinner-btn"><span class="btn-text">Guardar Producto</span><div class="spinner"></div></button>
            </form>
        </div>
        <div id="prompt-container"></div>
    </div>

    <!-- SCRIPTS -->
    <script src="https://unpkg.com/html5-qrcode/html5-qrcode.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAG2rhzDqoy_Iq6DlP0osuJjbrwFEtl6n4",
            authDomain: "tienda-twins.firebaseapp.com",
            projectId: "tienda-twins",
            storageBucket: "tienda-twins.appspot.com",
            messagingSenderId: "331341386452",
            appId: "1:331341386452:web:1f0c5257beaaccfcf86141",
            measurementId: "G-QYLGN5ZWX6"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        const vendedores = ["Vendedor A", "Vendedor B", "Vendedor C"];
        const colores = ["Negro espacial", "Plata", "Dorado", "Púrpura oscuro", "Rojo (Product RED)", "Azul", "Verde", "Blanco estelar", "Medianoche", "Titanio Natural", "Titanio Azul", "Otro"];
        const almacenamientos = ["128GB", "256GB", "512GB", "1TB"];
        const detallesEsteticos = ["Como Nuevo (Sin detalles)", "Excelente (Mínimos detalles)", "Bueno (Detalles de uso visibles)", "Regular (Marcas o rayones notorios)"];
        const modelos = [ "iPhone 11", "iPhone 11 Pro", "iPhone 11 Pro Max", "iPhone 12 Mini", "iPhone 12", "iPhone 12 Pro", "iPhone 12 Pro Max", "iPhone 13 Mini", "iPhone 13", "iPhone 13 Pro", "iPhone 13 Pro Max", "iPhone 14", "iPhone 14 Plus", "iPhone 14 Pro", "iPhone 14 Pro Max", "iPhone 15", "iPhone 15 Plus", "iPhone 15 Pro", "iPhone 15 Pro Max", "iPhone 16", "iPhone 16 Plus", "iPhone 16 Pro", "iPhone 16 Pro Max",];

        const s = {};
        document.addEventListener('DOMContentLoaded', initApp);

        function initApp() {
            Object.assign(s, {
                loginContainer: document.getElementById('login-container'), appContainer: document.getElementById('app-container'), logoutButton: document.getElementById('logout-button'),
                tabDashboard: document.getElementById('tab-dashboard'), tabManagement: document.getElementById('tab-management'),
                dashboardView: document.getElementById('dashboard-view'), managementView: document.getElementById('management-view'),
                btnShowStock: document.getElementById('btn-show-stock'), btnShowSales: document.getElementById('btn-show-sales'),
                stockSection: document.getElementById('stock-section'), salesSection: document.getElementById('sales-section'),
                stockTableContainer: document.getElementById('stock-table-container'), salesTableContainer: document.getElementById('sales-table-container'),
                filterStockModel: document.getElementById('filter-stock-model'), filterStockColor: document.getElementById('filter-stock-color'),
                filterStockGb: document.getElementById('filter-stock-gb'), filterStockBatMin: document.getElementById('filter-stock-bat-min'),
                filterStockBatMax: document.getElementById('filter-stock-bat-max'), btnApplyStockFilters: document.getElementById('btn-apply-stock-filters'),
                filterSalesVendedor: document.getElementById('filter-sales-vendedor'), filterSalesStartDate: document.getElementById('filter-sales-start-date'),
                filterSalesEndDate: document.getElementById('filter-sales-end-date'), btnApplySalesFilters: document.getElementById('btn-apply-sales-filters'),
                btnScan: document.getElementById('btn-scan'), scannerContainer: document.getElementById('scanner-container'),
                productForm: document.getElementById('product-form'), imeiInput: document.getElementById('imei-form'),
                modeloFormSelect: document.getElementById('modelo-form'), colorFormSelect: document.getElementById('color-form'),
                almacenamientoFormSelect: document.getElementById('almacenamiento-form'), detallesFormSelect: document.getElementById('detalles-form'),
                feedbackMessage: document.getElementById('feedback-message'), promptContainer: document.getElementById('prompt-container')
            });
            
            populateSelect(s.filterSalesVendedor, vendedores, "Todos los vendedores");
            populateSelect(s.filterStockColor, colores, "Todos los colores");
            populateSelect(s.filterStockGb, almacenamientos, "Todos los almacenamientos");
            populateSelect(s.filterStockModel, modelos, "Todos los modelos");
            populateSelect(s.modeloFormSelect, modelos, "Selecciona un modelo...");
            populateSelect(s.colorFormSelect, colores, "Selecciona un color...");
            populateSelect(s.almacenamientoFormSelect, almacenamientos, "Selecciona...");
            populateSelect(s.detallesFormSelect, detallesEsteticos, "Selecciona...");

            auth.onAuthStateChanged(user => {
                if (user) {
                    s.loginContainer.innerHTML = ''; s.loginContainer.classList.add('hidden');
                    s.appContainer.classList.remove('hidden'); s.btnShowStock.click();
                } else {
                    s.loginContainer.classList.remove('hidden'); s.appContainer.classList.add('hidden');
                    s.loginContainer.innerHTML = `<h1>Iniciar Sesión</h1><form id="login-form"><div id="login-feedback" class="hidden"></div><div class="form-group"><label for="email">Email</label><input type="email" id="email" required></div><div class="form-group"><label for="password">Contraseña</label><input type="password" id="password" required></div><button type="submit" id="btn-login" class="spinner-btn"><span class="btn-text">Entrar</span><div class="spinner"></div></button></form>`;
                    document.getElementById('login-form').addEventListener('submit', handleLogin);
                }
            });
            s.logoutButton.addEventListener('click', () => auth.signOut());
            s.tabDashboard.addEventListener('click', () => switchTab(true));
            s.tabManagement.addEventListener('click', () => switchTab(false));
            s.btnShowStock.addEventListener('click', () => switchDashboardView(true));
            s.btnShowSales.addEventListener('click', () => switchDashboardView(false));
            s.btnApplyStockFilters.addEventListener('click', loadStock);
            s.btnApplySalesFilters.addEventListener('click', loadSales);
            s.btnScan.addEventListener('click', startScanner);
            s.productForm.addEventListener('submit', handleProductFormSubmit);
        }
        
        const populateSelect = (selectEl, options, defaultText) => { if (selectEl) selectEl.innerHTML = `<option value="">${defaultText}</option>` + options.map(opt => `<option value="${opt}">${opt}</option>`).join(''); };
        const toggleSpinner = (btn, isLoading) => { if(btn) btn.classList.toggle('loading', isLoading); };
        
        async function handleLogin(e) { /* ...código anterior... */ }
        function switchTab(isDashboard) { /* ...código anterior... */ }
        function switchDashboardView(isStock) { /* ...código anterior... */ }
        async function loadStock() { /* ...código anterior... */ }
        async function loadSales() { /* ...código anterior... */ }
        function handleDBError(error, container, context) { /* ...código anterior... */ }

        const html5QrCode = new Html5Qrcode("scanner-container");
        function startScanner() {
            resetManagementView();
            s.btnScan.classList.add('hidden');
            s.scannerContainer.classList.remove('hidden');

            const config = {
                fps: 10,
                qrbox: { width: 250, height: 150 },
                experimentalFeatures: { useBarCodeDetectorIfSupported: true },
                advanced: [{ focusMode: "continuous" }]
            };

            html5QrCode.start({ facingMode: "environment" }, config, async (decodedText) => {
                await html5QrCode.stop();
                onScanSuccess(decodedText);
            }, (error) => {}).catch(err => { showFeedback("Error al iniciar cámara.", "error"); });
        }
        async function onScanSuccess(imei) { /* ...código anterior... */ }
        function promptToSell(imei, details) { /* ...código anterior... */ }
        async function registerSale(imei, productDetails, btn) { /* ...código anterior... */ }
        async function handleProductFormSubmit(e) { /* ...código anterior... */ }
        function resetManagementView() { /* ...código anterior... */ }
        function showFeedback(message, type = 'info') { /* ...código anterior... */ }

        // --- BLOQUE DE CÓDIGO COMPLETO (REPETIDO PARA GARANTIZAR) ---
        async function handleLogin(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            toggleSpinner(btn, true);
            try { await auth.signInWithEmailAndPassword(e.target.email.value, e.target.password.value); }
            catch (error) {
                const feedbackEl = document.getElementById('login-feedback');
                feedbackEl.textContent = "Error: " + error.message;
                feedbackEl.className = 'error';
                feedbackEl.classList.remove('hidden');
            } finally { toggleSpinner(btn, false); }
        }
        function switchTab(isDashboard) {
            s.dashboardView.classList.toggle('hidden', !isDashboard);
            s.managementView.classList.toggle('hidden', isDashboard);
            s.tabDashboard.classList.toggle('active', isDashboard);
            s.tabManagement.classList.toggle('active', !isDashboard);
        }
        function switchDashboardView(isStock) {
            s.stockSection.classList.toggle('hidden', !isStock);
            s.salesSection.classList.toggle('hidden', isStock);
            s.btnShowStock.classList.toggle('active', isStock);
            s.btnShowSales.classList.toggle('active', !isStock);
            if (isStock) loadStock(); else loadSales();
        }
        async function loadStock() {
            s.stockTableContainer.innerHTML = `<p class="dashboard-loader">Cargando stock...</p>`;
            try {
                let query = db.collection("stock_individual").where("estado", "==", "en_stock");
                if (s.filterStockModel.value) query = query.where('modelo', '==', s.filterStockModel.value);
                if (s.filterStockColor.value) query = query.where('color', '==', s.filterStockColor.value);
                if (s.filterStockGb.value) query = query.where('almacenamiento', '==', s.filterStockGb.value);
                if (s.filterStockBatMin.value) query = query.where('bateria', '>=', parseInt(s.filterStockBatMin.value));
                if (s.filterStockBatMax.value) query = query.where('bateria', '<=', parseInt(s.filterStockBatMax.value));

                query = query.orderBy('modelo');
                const querySnapshot = await query.get();
                if (querySnapshot.empty) { s.stockTableContainer.innerHTML = `<p class="dashboard-loader">No se encontraron productos con esos filtros.</p>`; return; }
                let tableHTML = `<table><thead><tr><th>Modelo</th><th>Color</th><th>GB</th><th>Batería</th><th>IMEI</th><th>Detalles</th></tr></thead><tbody>`;
                querySnapshot.forEach(doc => {
                    const item = doc.data();
                    tableHTML += `<tr><td>${item.modelo || ''}</td><td>${item.color || ''}</td><td>${item.almacenamiento || ''}</td><td>${item.bateria || ''}%</td><td>${item.imei || ''}</td><td>${item.detalles_esteticos || ''}</td></tr>`;
                });
                s.stockTableContainer.innerHTML = tableHTML + `</tbody></table>`;
            } catch (error) { handleDBError(error, s.stockTableContainer, "stock"); }
        }
        async function loadSales() {
            s.salesTableContainer.innerHTML = `<p class="dashboard-loader">Cargando ventas...</p>`;
            try {
                let query = db.collection("ventas").orderBy("fecha_venta", "desc");
                if (s.filterSalesVendedor.value) query = query.where('vendedor', '==', s.filterSalesVendedor.value);
                if (s.filterSalesStartDate.value) query = query.where('fecha_venta', '>=', new Date(s.filterSalesStartDate.value));
                if (s.filterSalesEndDate.value) {
                    const endDate = new Date(s.filterSalesEndDate.value);
                    endDate.setHours(23, 59, 59, 999);
                    query = query.where('fecha_venta', '<=', endDate);
                }
                const querySnapshot = await query.limit(100).get();
                if (querySnapshot.empty) { s.salesTableContainer.innerHTML = `<p class="dashboard-loader">No se encontraron ventas con esos filtros.</p>`; return; }
                let tableHTML = `<table><thead><tr><th>Fecha</th><th>Producto</th><th>Vendedor</th><th>Precio (USD)</th><th>Pago</th><th>Detalles Pago</th></tr></thead><tbody>`;
                querySnapshot.forEach(doc => {
                    const venta = doc.data();
                    const fecha = venta.fecha_venta ? new Date(venta.fecha_venta.seconds * 1000).toLocaleString('es-AR') : 'N/A';
                    const productoInfo = `${venta.producto.modelo || ''} ${venta.producto.color || ''}`;
                    let pagoDetalle = venta.metodo_pago === 'pesos' ? `ARS ${venta.monto_pesos || ''} (T/C ${venta.cotizacion_dolar || ''})` : '-';
                    tableHTML += `<tr><td>${fecha}</td><td>${productoInfo}</td><td>${venta.vendedor}</td><td>$${venta.precio_venta_usd}</td><td>${venta.metodo_pago}</td><td>${pagoDetalle}</td></tr>`;
                });
                s.salesTableContainer.innerHTML = tableHTML + `</tbody></table>`;
            } catch (error) { handleDBError(error, s.salesTableContainer, "ventas"); }
        }
        function handleDBError(error, container, context) {
            console.error(`Error cargando ${context}:`, error);
            let msg = `Error al cargar ${context}.`;
            if (error.code === 'failed-precondition') { msg = `Error: Esta consulta requiere un índice. Por favor, crea uno en la consola de Firebase. Revisa la consola (F12) para ver el link.`; }
            container.innerHTML = `<p class="dashboard-loader" style="color:var(--error-bg)">${msg}</p>`;
        }
        async function onScanSuccess(imei) {
            showFeedback("Buscando IMEI...", "loading");
            try {
                const imeiRef = db.collection("stock_individual").doc(imei.trim());
                const imeiDoc = await imeiRef.get();
                s.feedbackMessage.classList.add('hidden');
                if (imeiDoc.exists && imeiDoc.data().estado === 'en_stock') {
                    s.managementView.classList.add('hidden'); promptToSell(imei.trim(), imeiDoc.data());
                } else {
                    s.imeiInput.value = imei.trim(); s.productForm.classList.remove('hidden'); s.productForm.querySelector('select').focus();
                }
            } catch (error) { handleDBError(error, s.feedbackMessage, "búsqueda de IMEI"); }
        }
        function promptToSell(imei, details) {
            const vendedoresOptions = vendedores.map(v => `<option value="${v}">${v}</option>`).join('');
            s.promptContainer.innerHTML = `<div class="container container-sm" style="margin:auto;"><div class="prompt-box"><h3>Equipo Encontrado: ¿Registrar Venta?</h3><div class="details-box"><div class="detail-item"><span>Modelo:</span> <strong>${details.modelo || ''}</strong></div><div class="detail-item"><span>Color:</span> <strong>${details.color || ''}</strong></div><div class="detail-item"><span>IMEI:</span> <strong>${imei}</strong></div></div><form id="sell-form"><div class="form-group"><label for="precioVenta">Precio de Venta (USD)</label><input type="number" id="precioVenta" name="precioVenta" required placeholder="Ej: 850"></div><div class="form-group"><label for="metodoPago">Método de Pago</label><select id="metodoPago" name="metodoPago" required><option value="dolares">Dólares</option><option value="pesos">Pesos</option></select></div><div id="pesos-fields" class="hidden"><div class="form-group"><label for="tipoPagoPesos">Tipo de Pago en Pesos</label><select id="tipoPagoPesos" name="tipoPagoPesos"><option value="transferencia">Transferencia</option><option value="efectivo">Efectivo</option></select></div><div class="form-group"><label for="montoPesos">Monto en Pesos (ARS)</label><input type="number" id="montoPesos" name="montoPesos" placeholder="Ej: 850000"></div><div class="form-group"><label for="cotizacionDolar">Cotización del Dólar</label><input type="number" id="cotizacionDolar" name="cotizacionDolar" placeholder="Ej: 1000"></div></div><div class="form-group"><label for="vendedor">Vendedor</label><select id="vendedor" name="vendedor" required>${vendedoresOptions}</select></div><div class="form-group"><label for="gananciaVendedor">Ganancia Vendedor (USD)</label><input type="number" id="gananciaVendedor" name="gananciaVendedor" placeholder="Ej: 50"></div><div class="prompt-buttons"><button type="submit" class="prompt-button confirm spinner-btn"><span class="btn-text">Registrar Venta</span><div class="spinner"></div></button><button type="button" id="btn-cancel-sell" class="prompt-button cancel">Cancelar</button></div></form></div></div>`;
            document.getElementById('metodoPago').addEventListener('change', (e) => { document.getElementById('pesos-fields').classList.toggle('hidden', e.target.value !== 'pesos'); });
            document.getElementById('sell-form').addEventListener('submit', (e) => { e.preventDefault(); registerSale(imei, details, e.target.querySelector('button[type="submit"]')); });
            document.getElementById('btn-cancel-sell').onclick = () => { s.managementView.classList.remove('hidden'); s.promptContainer.innerHTML = ''; };
        }
        async function registerSale(imei, productDetails, btn) {
            toggleSpinner(btn, true);
            const formData = new FormData(btn.form);
            const saleData = { imei_vendido: imei, producto: productDetails, precio_venta_usd: parseFloat(formData.get('precioVenta')), metodo_pago: formData.get('metodoPago'), vendedor: formData.get('vendedor'), ganancia_vendedor_usd: formData.get('gananciaVendedor') ? parseFloat(formData.get('gananciaVendedor')) : 0, fecha_venta: firebase.firestore.FieldValue.serverTimestamp() };
            if (saleData.metodo_pago === 'pesos') { Object.assign(saleData, { tipo_pago_pesos: formData.get('tipoPagoPesos'), monto_pesos: parseFloat(formData.get('montoPesos')), cotizacion_dolar: parseFloat(formData.get('cotizacionDolar')) }); }
            const individualStockRef = db.collection("stock_individual").doc(imei);
            const displayProductRef = db.collection("productos_display").doc(`${(productDetails.modelo || '').toLowerCase().replace(/\s+/g, '-')}-${(productDetails.color || '').toLowerCase().replace(/\s+/g, '-')}`);
            const saleRef = db.collection("ventas").doc();
            try {
                await db.runTransaction(async (t) => {
                    const displayDoc = await t.get(displayProductRef);
                    t.update(individualStockRef, { estado: 'vendido' });
                    if (displayDoc.exists) {
                        const newStock = Math.max(0, (displayDoc.data().stock_total || 1) - 1);
                        t.update(displayProductRef, { stock_total: newStock, opciones_disponibles: firebase.firestore.FieldValue.arrayRemove({ imei: imei, gb: productDetails.almacenamiento, bateria: productDetails.bateria }) });
                    }
                    t.set(saleRef, saleData);
                });
                s.promptContainer.innerHTML = ''; s.btnShowSales.click();
            } catch (error) { console.error("Error al registrar la venta:", error); alert("Error al procesar la venta. Revisa la consola."); } 
            finally { toggleSpinner(btn, false); }
        }
        async function handleProductFormSubmit(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            toggleSpinner(btn, true);
            const formData = new FormData(e.target);
            const imei = formData.get('imei');
            const unitData = { imei: imei, modelo: formData.get('modelo'), color: formData.get('color'), bateria: parseInt(formData.get('bateria')), almacenamiento: formData.get('almacenamiento'), detalles_esteticos: formData.get('detalles'), estado: 'en_stock', fechaDeCarga: firebase.firestore.FieldValue.serverTimestamp() };
            const productId = `${(unitData.modelo || '').toLowerCase().replace(/\s+/g, '-')}-${(unitData.color || '').toLowerCase().replace(/\s+/g, '-')}`;
            const individualStockRef = db.collection("stock_individual").doc(imei);
            const displayProductRef = db.collection("productos_display").doc(productId);
            try {
                await db.runTransaction(async (t) => {
                    const existingImei = await t.get(individualStockRef);
                    if (existingImei.exists && existingImei.data().estado === 'en_stock') throw new Error(`El IMEI ${imei} ya está en stock.`);
                    const displayDoc = await t.get(displayProductRef);
                    t.set(individualStockRef, unitData);
                    if (!displayDoc.exists) { t.set(displayProductRef, { nombre: unitData.modelo, color: unitData.color, stock_total: 1, opciones_disponibles: [{ imei: unitData.imei, gb: unitData.almacenamiento, bateria: unitData.bateria }] });
                    } else { t.update(displayProductRef, { stock_total: firebase.firestore.FieldValue.increment(1), opciones_disponibles: firebase.firestore.FieldValue.arrayUnion({ imei: unitData.imei, gb: unitData.almacenamiento, bateria: unitData.bateria }) }); }
                });
                showFeedback(`¡Éxito! ${unitData.modelo} añadido al stock.`, "success");
                setTimeout(() => { resetManagementView(); s.btnShowStock.click(); }, 1500);
            } catch (error) { showFeedback(error.message || "Error al guardar.", "error"); }
            finally { toggleSpinner(btn, false); }
        }
        function resetManagementView() {
             s.promptContainer.innerHTML = ''; s.productForm.reset();
             s.productForm.classList.add('hidden'); s.btnScan.classList.remove('hidden');
             s.scannerContainer.classList.add('hidden');
             s.feedbackMessage.classList.add('hidden');
        }
        function showFeedback(message, type = 'info') {
            s.feedbackMessage.textContent = message;
            s.feedbackMessage.className = `feedback-message ${type}`;
            s.feedbackMessage.classList.remove('hidden');
        }
    </script>
</body>
</html>